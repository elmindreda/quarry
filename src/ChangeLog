2005-01-19  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-new-game-dialog.c (update_game_and_players_page):
	Use gtk_preferences_have_non_hidden_gtp_engine() to determine if
	there are computer opponents available.

	* gui-gtk/gtk-preferences.c (gtk_preferences_init): Add
	`ENGINES_IS_VISIBLE' column to tree model.  Recompute engine names
	based on `screen_name' fields.  For GTK+ 2.4+ create a filtered
	model based on this column.
	(create_gtp_engines_page): Add "Show" column to the list.  Fix
	"Support game(s):" label.  Create a label for displaying
	additional information.
	(gtk_preferences_dialog_update_gtp_engine_info): Don't allow
	removing engines coming from site configuration.  Show whether
	engine is coming from there in additional label.
	(show_or_hide_gtp_engine): New function.
	(do_remove_gtp_engine): Use
	gtk_preferences_have_non_hidden_gtp_engine().
	(gtk_preferences_have_non_hidden_gtp_engine): New function.
	(gtk_preferences_create_engine_selector): Use filtered model for
	GTK+ 2.4+ to exclude hidden engines.
	(gtk_preferences_set_engine_selector_selection): Take hidden
	engines into account.
	(gtk_preferences_get_engine_selector_selection): Likewise.
	(build_and_attach_menu): Likewise.
	(update_engine_screen_name): Add `update_tree_model' argument.

	* gui-gtk/gui-back-end.c (initialize_main_loop): Read site
	configuration file if the user doesn't have any configuration yet.

	* gui-utils/common-configuration-values.list: Add values for
	tracking site configuration and hidden engines to
	`gtp_engine_section_values'.
	* gui-utils/common-configuration-defaults.list: Likewise.

	* gui-utils/configuration.c (configuration_read_from_file):
	Support new `VALUE_TYPE_BOOLEAN_WRITE_TRUE_ONLY' value type.
	(write_section): Likewise.
	(configuration_init_repeatable_section): New function.

	* gui-utils/parse-configuration.c (configuration_parse_values2):
	Support new `VALUE_TYPE_BOOLEAN_WRITE_TRUE_ONLY' value type.
	(configuration_parse_defaults2): Likewise.
	(add_field_declaration_if_needed): Likewise.
	(look_at_field_type): New function.

	* utils/string-list.c (string_list_dispose_item)
	(string_list_steal_item, string_list_steal_first_item): New
	functions.

2005-01-18  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (leave_game_mode): New function.
	(do_resign_game): Call leave_game_mode().
	(move_has_been_played): Call time_control_*() functions itself,
	GtkClock doesn't do it anymore.  Call leave_game_mode() if the
	move is too late or if the game ends normally.
	(move_has_been_generated): Ignore move when not in game mode.
	(start_clock_if_needed): Call time_control_start().
	(player_is_out_of_time): New function.

	* gui-gtk/gtk-clock.c (gtk_clock_init): Initialize all fields.
	(gtk_clock_realize): Call set_background_pixmap().
	(set_background_pixmap): New function.
	(gtk_clock_finalize): Don't assume that GLib event source exists
	if `time_control' is set.
	(gtk_clock_start, gtk_clock_stop)
	(gtk_clock_initialize_for_time_control, clock_set_time): Remove
	functions.
	(gtk_clock_set_time, gtk_clock_use_time_control)
	(gtk_clock_time_control_state_changed)
	(fetch_time_from_time_control, do_set_time, ensure_clock_size)
	(clock_tick_callback):New functions, partially inherit removed
	code.
	(time_control_watch_prepare, time_control_watch_check)
	(time_control_watch_dispatch)
	(time_control_watch_source_set_tick_time): New functions.

	* gui-utils/time-control.c
	(time_control_get_time_till_seconds_update)
	(time_control_is_short_on_time): New functions.

2005-01-17  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_save): Don't show
	warning about potential information loss.

	* sgf/sgf-writer.c (write_game_tree): Write `ST' property value,
	if set.
	(sgf_write_list_of_vector): Implement.
	(sgf_write_figure_description): New function.

	* sgf/sgf-parser.c (sgf_parse_constrained_number): Also handle
	`PM' property.
	(sgf_parse_list_of_point): Use end_parsing_value() instead of
	next_token_in_value() so that whitespaces is warned about.
	(sgf_parse_list_of_vector): Implement.
	(sgf_parse_list_of_label): Treat non-composite values as values
	with empty label.
	(sgf_parse_figure): Implement.
	(sgf_parse_print_mode): Remove function.
	(sgf_parse_style): Implement.

	* sgf/sgf-errors.list (SGF_WARNING_DUPLICATE_VECTOR)
	(SGF_ERROR_ZERO_LENGTH_VECTOR, SGF_WARNING_UNKNOWN_FLAGS)
	(SGF_ERROR_FIGURE_FLAGS_EXPECTED, SGF_WARNING_UNKNOWN_PRINT_MODE):
	New error strings.

	* sgf/sgf-properties.list (ST): Use `not_stored' storage type.
	(FG): Change storage type to `figure_description'.
	(PM): Use `sgf_parse_constrained_number' as value parser.

	* sgf/sgf-tree.c (sgf_game_tree_new): Initialize new
	`style_is_set' field.
	(sgf_game_tree_duplicate): Copy `style' field only if it is set.
	(sgf_node_get_list_of_label_property_value): New function.
	(sgf_node_add_pointer_property): Handle values of
	`SGF_FIGURE_DESCRIPTION' type.
	(sgf_property_duplicate): Handle values of `SGF_LIST_OF_VECTOR'
	and `SGF_FIGURE_DESCRIPTION' types.
	(free_property_value): Handle `SGF_FIGURE_DESCRIPTION' value type.
	(SGF_VECTOR_LIST_DEFAULT_INITIAL_SIZE)
	(SGF_VECTOR_LIST_SIZE_INCREMENT): New macros.
	(sgf_vector_list_new, sgf_vector_list_shrink)
	(sgf_vector_list_add_vector, sgf_vector_list_has_vector)
	(sgf_vector_list_duplicate, sgf_figure_description_new)
	(sgf_figure_description_duplicate)
	(sgf_figure_description_delete): New functions.

	* sgf/sgf.h (sgf_vector_list_delete): New macro.

2005-01-15  Paul Pogonyshev  <pogonyshev@gmx.net>

	* (Quarry version 0.1.12.)

	* sgf/sgf-tree-map.c (VIEW_PORT_NODE, VIEW_PORT_LINE_ADJUSTMENT):
	New macros.
	(sgf_game_tree_get_current_branch_marks): New function.
	(sgf_game_tree_node_is_within_view_port): Bug-fix: don't assume
	that the requested view port dimensions match internal view port.
	(update_internal_view_port): Check if internal view port already
	contains necessary data (was previously checked at higher level.)
	(do_update_internal_view_port): Bug-fix: remove primary tree line
	storage out of the `for' loop, could cause serious memory
	corruption (bug #1969, Arend Bayer.)

	* sgf/sgf-utils.c (do_enter_tree): Adjust new `current_node_depth'
	field according to changes of `current_node'.
	(descend_nodes): Likewise.
	(ascend_nodes): Likewise.

	* sgf/sgf-tree.c (sgf_game_tree_new): Initialize new
	`current_node_depth' field.
	(sgf_game_tree_set_state): Also save `current_node_depth'.  Change
	prototype and don't return old state.
	(sgf_game_tree_get_state): New function, break out of
	sgf_game_tree_set_state().

2005-01-06  Paul Pogonyshev  <pogonyshev@gmx.net>

	* (Quarry version 0.1.11.)

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Maximize the
	window by default.
	(sgf_tree_view_clicked): New function.

	* gui-gtk/gtk-utils.c (gtk_utils_set_sensitive_on_toggle): Add
	`reverse_meaning' argument.
	(set_widget_sensitivity_on_toggle_reversed): New function.

	* gui-gtk/gtk-preferences.c (create_game_tree_page): Add controls
	for tracking current node configuration parameters.
	(store_radio_button_setting): Bug-fix: radio button groups are in
	reverse-creation order, cope with that.  Use library functions.
	(update_markup_theme_defaults_usage): Always initialize
	`use_theme_defaults'.

	* gui-utils/common-configuration-sections.list: Rename "Editing
	and Viewing" section to "Game Tree View".
	* gui-utils/common-configuration-values.list: Add values for
	whether to track current node in the game tree view.
	* gui-utils/common-configuration-defaults.list: Likewise.  Also
	change the default for `show_game_tree' to
	`SHOW_GAME_TREE_AUTOMATICALLY'.

	* gui-gtk/gtk-sgf-tree-view.c (gtk_sgf_tree_view_class_init): Add
	integer `button_index' argument to "sgf-tree-view-clicked" signal.
	(gtk_sgf_tree_view_init): Don't call gtk_goban_base_set_game().
	Initialize new `map_width' and `map_height' fields.
	(gtk_sgf_tree_view_realize): Call
	sgf_game_tree_get_map_dimensions() instead of update_view_port().
	(gtk_sgf_tree_view_size_request): Base size request on internal
	`map_width' and `map_height' fields.
	(gtk_sgf_tree_view_expose): Draw a cross over collapsed nodes.
	(gtk_sgf_tree_view_button_press_event)
	(gtk_sgf_tree_view_button_release_event): Also pass on right
	button clicks.
	(gtk_sgf_tree_view_unrealize): Free view port data.
	(gtk_sgf_tree_view_finalize): Don't free view port (unneeded.)
	(gtk_sgf_tree_view_set_sgf_tree): Don't call removed
	sgf_game_tree_activate_map(); call gtk_goban_base_set_game().
	(gtk_sgf_tree_view_update_view_port): Scroll view port as needed
	when tracking the current node.
	(configure_adjustment): Use `map_width' and `map_height'.
	(update_view_port_and_maybe_move_or_resize_window): Make
	`original_hadjustment_value' and `original_vadjustment_value'
	arguments.  Replace first call to update_view_port() with a call
	to sgf_game_tree_get_map_dimensions().  Request full redraw if
	window size changes.

	* gui-gtk/quarry-marshal.list: New marshaller `VOID:POINTER,INT'.

	* sgf/sgf-utils.c (sgf_utils_append_variation): Pass
	`tree->current_node' to sgf_game_tree_invalidate_map().
	(sgf_utils_set_node_is_collapsed): New function.

	* sgf/sgf-tree-map.c (REPORT_PERFORMANCE_STATISTICS): Rename macro
	from `PRINT_RUN_TIMES'.
	(DECLARE_TIME_VARIABLES, STORE_STARTING_TIME, PRINT_RUN_TIME)
	(MIN_NODES_PER_DATA_CHUNK): New macros.
	(sgf_game_tree_activate_map, sgf_game_tree_deactivate_map): Remove
	functions.
	(sgf_game_tree_invalidate_map): Add `node' parameter and rewrite
	to handle new intermediate data.
	(sgf_game_tree_get_map_dimensions): New function.
	(sgf_game_tree_fill_map_view_port): Rename from
	sgf_game_tree_update_view_port().
	(sgf_game_tree_get_node_coordinates)
	(sgf_game_tree_node_is_within_view_port)
	(find_intermediate_data_for_node, view_port_is_after_data_point)
	(view_port_is_before_data_point, free_map_data_point)
	(update_internal_map_data): New functions.
	(update_internal_view_port): Optimize for speed capitalizing on
	data stored by update_internal_map_data().
	(do_update_internal_view_port): Break out of
	update_internal_view_port().
	(get_node_coordinates): New function.

2005-01-03  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-tree.c (sgf_game_tree_new): Initialize new
	`map_data_list' field.
	(sgf_game_tree_delete): Call sgf_game_tree_invalidate_map() to
	free all memory allocated for the map.
	(sgf_node_new): Initialize new `has_intermediate_map_data' field.

2004-12-31  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-base.c (gtk_goban_base_unrealize): Call
	parent's method.

2004-12-30  Paul Pogonyshev  <pogonyshev@gmx.net>

	* board/board.c (board_position_list_union): Rewrite to avoid
	accessing unallocated memory in some cases (bug #1929,
	warped_dragon@hotmail.com.)

	* gui-gtk/gtk-goban-window.c (move_has_been_played): Add time
	control information to the game SGF tree.

	* gui-gtk/gtk-new-game-dialog.c (begin_game): Add information
	about game time limits to the game SGF tree.

	* sgf/sgf-properties.list: Sort `TM' property before 'OT'.
	(MN, OB, OW): Use `sgf_parse_constrained_number' as value parser.

	* sgf/sgf-parser.c (parse_buffer): Reset new
	`data->ko_property_error_position.line' field.  Delete error lists
	when parsing failed with `SGF_INVALID_FILE'.
	(complete_node_and_update_board): Add error if there is `KO'
	property, but no move in the node.  Split nodes with setup
	properties and `MN' mixed.
	(sgf_parse_none): Store error position if parsing `KO' property.
	(sgf_parse_constrained_number): New function.
	(sgf_parse_move_number, sgf_parse_moves_left): Remove functions.
	(insert_error_valist): Bug-fix: store line and column in the
	inserted item, not in the last.

	* sgf/sgf-errors.list (SGF_ERROR_KO_PROPERTY_WITHOUT_MOVE): New
	error string.

	* utils/string-list.c (string_list_insert): Return the inserted
	item.
	(string_list_insert_from_buffer): Likewise.
	(string_list_insert_ready): Likewise.
	(string_list_insert_ready_item): Likewise.

	* sgf/sgf-tree.c (sgf_node_find_property): Allow `link' to be
	NULL.

2004-12-29  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-parser-interface.c (analyze_parsed_data): Cast
	`data->parent' to GtkWindow type only when non-NULL.  If there is
	no parent window, make error dialog non-modal and register it with
	gtk_control_center_window_created().
	(gtk_parse_sgf_file): Likewise.  Also fix for changed
	gtk_utils_create_message_dialog() prototype.

	* sgf/sgf-tree-map.c (update_internal_view_port): Fix bug that
	caused overlapping branches in rare cases (reported by Arend
	Bayer.)

2004-12-25  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-preferences.c (update_board_markup_theme): Bug-fix:
	duplicate theme name, don't just copy the pointer.

	* gui-gtk/gtk-sgf-tree-view.c (gtk_sgf_tree_view_realize): Call
	parent class method.

	* gui-gtk/gtk-goban.c (gtk_goban_set_parameters): Don't emit
	`appearance-changed' signal.
	(gtk_goban_realize): Call parent class method.
	(gtk_goban_size_allocate): Don't calculate stones and SGF markup
	margins.
	(gtk_goban_expose): Use new compute_goban_margins() function.
	(gtk_goban_appearance_changed): Remove function.
	(gtk_goban_allocate_screen_resources)
	(gtk_goban_free_screen_resources): New functions, inherit code of
	removed gtk_goban_base_appearance_changed().
	(gtk_goban_finalize): Don't unreference `small_tile_set'.
	(gtk_goban_update): Use compute_goban_margins().
	(set_overlay_data): Likewise.
	(compute_goban_margins): New function.

	* gui-gtk/gtk-goban-base.c (gtk_goban_base_class_init): Create
	`allocate-screen-resources' and `free-screen-resources' signals;
	don't create `appearance-changed' signal.
	(gtk_goban_base_realize, gtk_goban_base_unrealize): New functions.
	(gtk_goban_base_appearance_changed): Remove function.
	(gtk_goban_base_allocate_screen_resources)
	(gtk_goban_base_free_screen_resources): New functions, inherit
	code of removed gtk_goban_base_appearance_changed().
	(gtk_goban_base_finalize): Don't unreference tile sets here.
	(gtk_goban_base_update_appearance): Emit the new signals, not
	`appearance-changed' and only if the widget is realized.
	(gtk_goban_base_set_cell_size): Likewise.

	* gui-gtk/gtk-assistant.c (gtk_assistant_update_buttons):
	Workaround GTK+ 2.0 problem that caused annoying warnings in some
	cases.

	* quarry.c (main): Parse command line after gui_back_end_init() is
	called so that GTK+/GLib options are not seen by getopt_long().

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Add "New
	Game" and "Control Center" menu items.
	(save_file_as_response): Call update_window_title() when saving to
	a (different) file.
	(show_or_hide_navigation_toolbar): Fix copy'n'paste bug: use
	`show_navigation_toolbar' field, not `show_main_toolbar' one.
	(update_window_title): When there is no game name, try to create
	window title from use players' names.  Set window title even if
	there's no base name.
	(initialize_gtp_player): Return 1 to indicate no error to the GTP
	client module.

	* gtp/gtp-client.c (parse_final_status_list): Take care to signal
	error only if the list is badly formatted.

	* gui-gtk/gtk-gtp-client-interface.c (log_gtp_stream_error): Don't
	assume that there is a log file, errors are reported regardless of
	GTP client's echo status.

	* gui-gtk/gtk-goban.c (gtk_goban_size_allocate): Fix bug with cell
	size calculation that occured when the resulting font was larger
	than requested (reported by Arend Bayer.)

2004-12-24  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-gtp-client-interface.c (gtk_create_gtp_client):
	Handle GTP debugging options: hook up necessary callbacks, create
	pipe and IO channel for child's stderr etc.
	(handle_engine_stderr, log_gtp_stream, log_gtp_stream_error): New
	functions.
	(client_deleted): Close stderr channel and log file if necessary.

	* gtp/gtp-client.c (gtp_client_grab_response): Report errors
	before response lines.  Properly ignore empty lines between
	responses.
	(dispatch_response): Send an empty line to `line_callback' after
	any potential error.
	(store_protocol_version): Send a warning about future GTP version.

	* quarry-main.h: New file.

	* quarry.c (main): Parse command line.  Add `--gtp-log',
	`--gtp-show-stderr', `--help', `--usage' and `--version' options.

2004-12-23  Paul Pogonyshev  <pogonyshev@gmx.net>

	* board/amazons.c (amazons_parse_move): Also parse moves in
	A1-B2/C3 and A1-B2xC3 formats (wish #1952,
	emarkus@cs.ualberta.ca.)

2004-12-22  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-parser.c (sgf_parse_list_of_label): When combining label
	lists ensure that the old list's text strings are not freed as we
	reuse them (bug reported by Arend Bayer.)

2004-12-11  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-preferences.c: Add "Game Tree" category.
	(create_saving_sgf_page): New function.
	(create_markup_box): Alter layout to reflect changes in theme
	default usage policy.  Remove two buttons and add a check button.
	(gtk_preferences_dialog_response): Handle
	`PREFERENCES_PAGE_GAME_TREE'.
	(update_board_background_texture): New function.
	(update_board_appearance): Remove accidental code duplication.
	(update_board_markup_theme): Rename from update_board_markup().
	(use_theme_default_size, use_theme_default_opacity): Remove
	functions.
	(update_markup_theme_defaults_usage): New function.

	* gui-gtk/gtk-utils.h (gtk_utils_block_signal_handlers)
	(gtk_utils_unblock_signal_handlers): New macros.

	* gui-gtk/gtk-tile-set.c
	(gtk_sgf_markup_tile_set_create_or_reuse): Adapt to new theme
	defaults usage scheme.

	* gui-utils/common-configuration-values.list: Add "Use theme
	defaults" value.  Add previously forgotten "Markup theme" value to
	`amazons_board_appearance_values'
	* gui-utils/common-configuration-defaults.list: Likewise for
	`use_theme_defaults'

	* sgf/sgf-tree-map.c (sgf_game_tree_update_view_port): Fix `if'
	condition, don't call update_internal_view_port() when not needed.

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Add "Game
	Tree" check menu item.  Don't pack `sgf_tree_view's parent widget
	to `vpaned' unless configured to always show game tree view.
	Initialize new `sgf_tree_view_visibility_locked' field.
	(gtk_goban_window_enter_game_mode): Never hide clocks.
	(gtk_goban_window_destroy): Unreference `sgf_tree_view's parent.
	(show_or_hide_sgf_tree_view, show_sgf_tree_view_automatically):
	New functions.
	(set_current_tree): When configured to show game tree view
	automatically, show/hide it depending on whether the new tree has
	any variations.  But respect `sgf_tree_view_visibility_locked',
	set by show_or_hide_sgf_tree_view() when invoked from menu.
	(update_children_for_new_node): Call
	show_sgf_tree_view_automatically() for `current_node'.
	(update_game_information): Never hide players' information.
	(update_player_information): Set return type to `void'.
	(move_has_been_generated): Call show_sgf_tree_view_automatically()
	for `game_position_node'.

2004-12-10  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-utils/common-configuration-sections.list: Add configuration
	parameter for whether and when to show game tree view.
	* gui-utils/common-configuration-values.list: Likewise.
	* gui-utils/common-configuration-defaults.list: Likewise.

	* gui-utils/configuration.c (configuration_read_from_file): Add
	support for `enumeration' value type.
	(parse_integer): New function, broken out of
	configuration_read_from_file().
	(write_section): Add support for `enumeration' value type.

	* gui-utils/parse-configuration.c (configuration_parse_sections2):
	Adjust output to follow modified (see `ChangeLog' entry of 12
	October) coding convention.
	(configuration_parse_values2): Likewise.
	(configuration_parse_defaults2): Likewise.
	(configuration_finalize_defaults): Likewise.
	(add_field_dispose_call_if_needed): Likewise.
	(finish_function): Likewise.
	(configuration_initialize_sections): Save `c_file_array_name' on
	the heap, don't write to `h_file_bottom' yet.
	(configuration_parse_values2): Add support for `enumeration' value
	type.
	(configuration_initialize_defaults): Perform write to
	`h_file_bottom' delayed in configuration_initialize_sections().
	(configuration_parse_defaults2): Add support for `enumeration'
	value type.
	(configuration_parse_defaults2): Likewise.
	(add_field_declaration_if_needed): Likewise.

	* gui-gtk/gtk-sgf-tree-view.c (gtk_sgf_tree_view_size_allocate):
	Remove debugging leftover.
	(gtk_sgf_tree_view_expose): Only draw if the widget is realized,
	not if `current_tree' is set.  Implement line clipping to
	workaround X drawing problems with very long lines (over 32K.)
	(gtk_sgf_tree_view_update_view_port): Do nothing if widget is not
	realized.

2004-12-09  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Add an
	GtkSgfTreeView to the sidebar.
	(set_current_tree): Inform `sgf_tree_view' about the change.
	(switch_to_given_node): New function.
	(update_children_for_new_node): Force `sgf_tree_view' view port
	update.
	(move_has_been_generated): Likewise if not displaying game node.

	* sgf/sgf-utils.c (sgf_utils_append_variation): Call new function
	sgf_game_tree_invalidate_map().

	* gui-gtk/gtk-sgf-tree-view.c, gui-gtk/gtk-sgf-tree-view.h: New
	files.

	* gui-gtk/quarry-marshal.list: New marshaller
	`VOID:OBJECT,OBJECT'.

	* sgf/sgf-parser.c (complete_node_and_update_board): Make last
	change work.

2004-12-08  Paul Pogonyshev  <pogonyshev@gmx.net>

	* utils/utils.c (utils_realloc): Don't choke if `realloc (..., 0)'
	returns NULL.

	* sgf/sgf-tree-map.c: New file.

	* sgf/sgf-tree.c (sgf_game_tree_new): Initialize new `user_data',
	`free_user_data', `map_width', `view_port_nodes' and
	`view_port_lines' fields.
	(sgf_game_tree_delete): Free `user_data' (if necessary),
	`view_port_nodes' and `view_port_lines' fields.
	(sgf_game_tree_set_user_data): New function.
	(sgf_node_new): Initialize new `is_collapsed' field.

2004-12-06  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-preferences.c (update_board_background_texture): Use
	gtk_goban_base_update_appearance() instead of
	gtk_goban_update_appearance().
	(update_board_markup): Likewise.
	(update_board_appearance): Likewise.

	* gui-gtk/gtk-goban.c (gtk_goban_get_type): Descend from
	GtkGobanBase, not GtkWidget.
	(gtk_goban_set_parameters): Use new function
	gtk_goban_base_set_game() and `appearance-changed' signal.
	(gtk_goban_size_allocate): Use new function
	gtk_goban_base_set_cell_size().  Be a nice inherited method and
	call parent's method instead of doing everything itself.
	(unreference_cached_objects, set_goban_style_appearance)
	(gtk_goban_appearance_changed): Remove functions (part of
	functionality went to `gui-gtk/gtk-goban-base.c'.)
	(gtk_goban_appearance_changed): New function (inherit most of
	set_goban_non_style_appearance() functionality.)
	(gtk_goban_update_appearance): Remove function (functionality
	inherited by gtk_goban_base_update_appearance().)

	* gui-gtk/gtk-goban-base.c, gui-gtk/gtk-goban-base.h: New
	files (part of `gui-gtk/gtk-goban.c' fuctionality.)

2004-11-30  Paul Pogonyshev  <pogonyshev@gmx.net>

	* (Quarry version 0.1.10.)

2004-11-29  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-help.c (gtk_help_display): Don't try to launch Yelp
	if ScrollKeeper wasn't found on configure stage.

2004-11-26  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (IS_IN_SPECIAL_MODE): New macro.
	(gtk_goban_window_init): Use `GTK_STOCK_PROPERTIES'es shortcut and
	icon for "Game Information" menu item.  Add "View" sub-menu.
	Rearrange "Go" sub-menu items so that "previous"-like items always
	go before "next"-like.
	(gtk_goban_window_init): Add main and navigation toolbars.  Add
	"Pass" and "Resign" buttons to the sidebar.  Tweak sidebar
	spacing.
	(gtk_goban_window_enter_game_mode): Call
	update_children_for_new_node() since result of
	USER_CAN_PLAY_MOVES() might change.  Bug-fix: don't start user's
	clock if the user is setting free handicap.
	(show_or_hide_main_toolbar, show_or_hide_navigation_toolbar)
	(show_or_hide_game_action_buttons): New functions.
	(set_current_tree): Show or hide "Pass" button depending on game.
	(play_resign): Ask user if she really wants to resign first.
	(do_resign_game): New function, broken out of play_resign().
	(update_children_for_new_node): Also sensitize/desensitize toolbar
	buttons and game action buttons.  Make "Pass" and "Resign" menu
	items and buttons insensitive when in special mode.
	(move_has_been_played): ReSet `in_game_mode' if game is over.
	(move_has_been_generated): Use do_resign_game() instead of
	play_resign().

	* gui-gtk/gtk-configuration.list: Add "GTK+ User Interface"
	section.

	* gui-utils/configuration.c (IS_ACCEPTABLE_NAME_CHARACTER): New
	macro.
	(configuration_read_from_file): Use
	IS_ACCEPTABLE_NAME_CHARACTER().  This allows digits, hyphen, plus
	sign and apostrophe in names, in addition to digits accepted
	before.

	* utils/string-buffer.c (string_buffer_vcprintf): Bug-fix:
	increase string length also when buffer reallocation is needed.

2004-11-25  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-utils.c (gtk_utils_append_toolbar_button)
	(invoke_toolbar_button_callback)
	(gtk_utils_set_toolbar_buttons_sensitive)
	(set_toolbar_item_sensitive): New functions.

2004-11-24  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (play_resign): Bug-fix: don't stop
	the clock if we don't have a time control in the first place.

2004-11-15  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-utils/configuration.c (configuration_read_from_file): Don't
	segfault on certain malformed input.
	(parse_string): Respect comments starting with '#' symbol (this
	will break old configuration files with custom colors.)
	(write_section): Write colors enclosed in quotes, because they
	contain '#' symbol.

	* sgf/sgf-tree.c (sgf_node_split): Bug-fix: set `node->move_color'
	to `EMPTY' since the move is moved to the child node.

	* sgf/sgf-parser.c (complete_node_and_update_board): Bug-fix:
	remove `PL' properties that have no effect, not those changing
	color to move.

2004-11-14  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (do_find_text): Scroll text view so
	that the found text is always visible.

2004-10-20  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban.c (gtk_goban_expose): Only use
	draw_horizontal_line_with_gaps() and
	draw_vertical_line_with_gaps() for Go, not other games.  Draw
	labels on black stones using white color.  Don't draw last move
	indicator over SGF labels.

	* gui-gtk/gtk-configuration.list: Add "Find Dialog Parameters"
	section.

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Add "Find",
	"Find Next" and "Find Previous" menu items.  Initialize new
	`find_dialog' and `text_to_find' fields.
	(gtk_goban_window_finalize): Free `text_to_find' and destroy
	`find_dialog' (if present.)
	(show_find_dialog, find_dialog_response)
	(find_dialog_parameters_changed, do_find_text)
	(strstr_whole_word, strrstr_whole_word)
	(char_is_word_constituent, get_normalized_text)
	(get_offset_in_original_text): New functions.
	(about_to_change_node, just_changed_node): New functions, broken
	out of navigate_goban().
	(playing_mode_goban_clicked): Bug-fix: invoke new
	about_to_change_node() and just_changed_node() when switching
	variations on right button click (could lead to game tree
	corruption when playing a game.)
	(update_move_information): Bug-fix: only call
	sgf_node_get_result() if there is a game-info node in the first
	place.

	* sgf/sgf-utils.c (sgf_utils_switch_to_given_node): New function.

2004-10-19  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/quarry-stock.c: New stock item `QUARRY_STOCK_PREVIOUS'.

	* sgf/sgf-tree.c (sgf_game_tree_traverse_forward)
	(sgf_game_tree_traverse_backward, sgf_node_traverse_forward)
	(sgf_node_traverse_backward): New functions.

	* gui-gtk/gtk-control-center.c (gtk_control_center_destroy):
	Remove function, use gtk_utils_null_pointer_on_destroy() instead.
	* gui-gtk/gtk-goban-window.c (save_file_as_destroy): Likewise.
	(game_info_dialog_destroyed): Likewise.
	(about_dialog_destroy): Likewise.
	* gui-gtk/gtk-preferences.c (gtk_preferences_dialog_destroy):
	Likewise.

	* gui-gtk/gtk-utils.c (gtk_utils_null_pointer_on_destroy)
	(null_pointer_on_destroy)
	(null_pointer_on_destroy_ask_control_center): New functions.

	* gui-gtk/gtk-goban-window.c (show_about_dialog): Fix copyright
	string (add year 2003.)  Center-justify copyright label.  Use
	`GTK_RESPONSE_CANCEL' for the "Close" button, so that the dialog
	can be closed with Escape.

2004-10-18  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban.c (gtk_goban_set_parameters): Update goban's
	hoshi points using new go_get_hoshi_points() function.
	(gtk_goban_size_allocate): Don't touch hoshi points here.
	(gtk_goban_expose): Use new draw_vertical_line_with_gaps() and
	draw_horizontal_line_with_gaps() to draw all lines.  Don't draw
	hoshi points over SGF labels.
	(draw_vertical_line_with_gaps, draw_horizontal_line_with_gaps):
	New functions.
	(gtk_goban_finalize): Free overlay data, don't leak memory.
	(gtk_goban_update): Adjust `rectangle_sgf_label' so that label
	gaps get redrawn properly.
	(find_hoshi_points): Remove function.

	* board/go.c (go_get_hoshi_points): New function, inherit code of
	removed find_hoshi_points() in `gui-gtk/gtk-goban.c'.

	* gui-gtk/gtk-new-game-dialog.c (begin_game): Bug-fix: duplicate
	"Void" string before passing it to sgf_node_add_text_property().

	* gui-gtk/gtk-utils.c (time_spin_button_output): Use
	utils_ncprintf() once more: now it knows about field width.

	* utils/utils.c (utils_vncprintf): Add support for field width
	This is an indirect bug-fix for write_section() in
	`gui-utils/configuration.c', it used to write time incorrectly.

2004-10-14  Paul Pogonyshev  <pogonyshev@gmx.net>

	* (Quarry version 0.1.9.)

	* gui-gtk/gtk-utils.c (freeze_on_empty_input): Use
	gtk_freezable_spin_button_freeze_and_stop_input().

	* gui-gtk/gtk-freezable-spin-button.c
	(gtk_freezable_spin_button_init): Reset new `is_in_output' field.
	(gtk_freezable_spin_button_new): Connect also to `input' signal.
	(gtk_freezable_spin_button_output): Set `is_in_output' while
	changing entry's text.
	(gtk_freezable_spin_button_input): New function.
	(gtk_freezable_spin_button_changed): Bug-fix: only unfreeze when
	changed not from our own `output' signal handler.
	(gtk_freezable_spin_button_freeze_and_stop_input): New function.

	* gui-gtk/gtk-game-info-dialog.c (gtk_game_info_dialog_init):
	Bug-fix: Call gtk_utils_convert_to_time_spin_button() after
	gtk_utils_freeze_on_empty_input(), so that
	time_spin_button_input() is the last handler.

2004-10-14  anonymous  <mateusz@kaduk.net>

	* gui-gtk/gtk-preferences.c (prepare_to_rebuild_menus)
	(rebuild_all_menus): Fix macro definition for GTK+ 2.4 broken by
	extra spaces (bug #898.)

2004-10-14  Paul Pogonyshev  <pogonyshev@gmx.net>

	* (Quarry version 0.1.8.)

2004-10-13  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (game_info_dialog_property_changed):
	New function.
	(update_player_information): Add a comma before ranks not starting
	with a digit (i.e. "Honinbo".)

	* gui-gtk/gtk-game-info-dialog.c: Enable editing of game
	information.  Add `property-changed' signal.
	(gtk_game_info_dialog_init): Remove temporary notice from dialog
	title.  Make all controls save their values (i.e. editable.)  Use
	GtkFreezableSpinButton for handicap, komi and main time entries.
	Adjust some mnemonic keys to make space for not yet added "Help"
	button.
	(create_and_pack_game_info_entry): New function.
	(gtk_game_info_dialog_set_node): Bug-fix: set `main_time'
	adjustment for all games, not just for Go.  Freeze spin buttons
	when properties have illegal (from SGF point of view) values.
	(game_info_entry_focus_out_event, game_comment_focus_out_event)
	(game_info_spin_button_value_changed)
	(game_info_spin_button_focus_out_event)
	(update_property_if_changed): New functions.

	* gui-gtk/gtk-utils.c (gtk_utils_create_freezable_spin_button):
	New function.
	(gtk_utils_convert_to_time_spin_button): New function, break out
	of gtk_utils_create_time_spin_button().
	(gtk_utils_set_text_buffer_text): New function, break out of
	update_children_for_new_node() (in `gui-gtk/gtk-goban-window.c'.)
	(gtk_utils_freeze_on_empty_input, freeze_on_empty_input): New
	functions.

	* gui-gtk/gtk-freezable-spin-button.c: New file.
	* gui-gtk/gtk-freezable-spin-button.h: New file.

2004-10-12  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-utils.c (sgf_utils_normalize_text): Add `is_simple_text'
	parameter.  Handle simple text.  Remove all occurences of '\r'
	character.  Don't leak `buffer' if `text' contains whitespace
	only.

	* gui-gtk/gtk-utils.h (GtkUtilsBrowsingDoneCallback): Make really
	the same as the prototype of the `focus-out-event' handler.
	* gui-gtk/gtk-preferences.c (update_board_background_texture):
	Likewise.

	* (Globally: put a space before opening parenthesis in function
	calls and so be closer to GNU coding standard.  Files will be
	converted only when some other change is being commited.)

2004-10-11  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-preferences.c (gtk_preferences_dialog_present): Add
	help button.
	(create_gtp_engines_page): Change "Supported games" label to
	"Supported game(s)".  Make "Supported game(s)" go before "Command
	line".
	(gtk_preferences_dialog_destroy): New function.
	(gtk_gtp_engine_dialog_response): Call
	gtk_progress_dialog_set_help_link_id().
	* gui-gtk/gtk-preferences.h: Add previously missed
	`PREFERENCES_PAGE_SGF_SAVING'.

	* gui-gtk/gtk-progress-dialog.c (gtk_progress_dialog_init): Reset
	new `help_link_id' field to NULL.
	(gtk_progress_dialog_update): New function.
	(gtk_progress_dialog_response): Handle `GTK_RESPONSE_HELP'.

	* gui-gtk/gtk-new-game-dialog.c (gtk_new_game_dialog_present):
	Change some mnemonic keys to make space for new "Help" button.
	Set help links for both assistant pages.
	(instantiate_players): New function.

	* gui-gtk/gtk-assistant.c (gtk_assistant_init): Initialize new
	`help_button' field to NULL.
	(gtk_assistant_update_buttons): Sensitize or desensitize help
	button if present.
	(gtk_assistant_response): Handle `GTK_RESPONSE_HELP'.
	(gtk_assistant_add_page): Reset new `help_link_id' and
	`help_link_id_callback' fields to NULL.
	(gtk_assistant_set_page_help_link_id)
	(gtk_assistant_set_page_help_link_id_callback): New functions.

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Add
	"Contents" (of "Help") menu item.
	(show_help_contents): New function.

	* gui-gtk/gtk-help.c, gui-gtk/gtk-help.h: New files.

2004-10-05  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-parser.c (parse_property): Adjust to changed storage of
	unknown properties.
	(parse_unknown_property_values): Likewise.  Add
	`property_value_list' argument; add values to that list.

2004-10-04  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-writer.c (do_write_text): Add `terminating_character'
	argument.  Output `terminating_character' in encoding specified by
	`CA' property, so that the file is parseable.
	(sgf_write_simple_text, sgf_write_text, sgf_write_list_of_label):
	Don't write terminating ']', do_write_text() does this now.
	(sgf_write_unknown): Adjust to work with changed storage of
	unknown properties.  Output ']' like do_write_text() now does.

	* sgf/sgf-tree.c (sgf_node_find_unknown_property)
	(sgf_property_duplicate, free_property_value): Cope with changed
	storage of unknown properties.
	(sgf_property_delete): Use free_property_value().
	(free_property_value): Compile unconditionally (for use from
	sgf_property_delete()).  Make `inline'.

	* sgf/sgf.h: Change storage of unknown properties: store them in
	`StringList's now.

2004-10-03  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban.c (gtk_goban_set_parameters): Reset `grid',
	`goban_markup', `sgf_markup' and `sgf_labels'.  Free `sgf_labels'
	strings if needed.
	(gtk_goban_expose): Render SGF labels.
	(gtk_goban_finalize): Free `sgf_labels' strings if needed.
	(gtk_goban_update): New argument `sgf_label_list'.  Use
	grid_copy() instead of memcpy().

	* gui-gtk/gtk-goban.h (KEEP_SGF_LABELS): New macro.

	* board/board.c (DO_FILL_GRID, DO_COPY_GRID): New macros.
	(board_fill_grid, board_fill_int_grid): Remove functions.
	(grid_fill, int_grid_fill, pointer_grid_fill): New functions,
	inherit removed functions' code.
	(grid_copy, int_grid_copy, pointer_grid_copy): New functions.
	* board/board.h (uint_grid_fill, board_fill_grid)
	(board_fill_int_grid, board_fill_pointer_grid, uint_grid_copy):
	New macros.

2004-09-13  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-utils.c (gtk_utils_workaround_focus_bug): New
	function.
	* gui-gtk/gtk-assistant.c (gtk_assistant_response): Use it.

	* gui-gtk/gtk-goban-window.c (USER_IS_TO_PLAY): New macro.
	(gtk_goban_window_enter_game_mode): Use USER_IS_TO_PLAY() instead
	of USER_CAN_PLAY_MOVES().
	(free_handicap_has_been_placed): Don't start clock if white player
	is a GTP engine that hasn't yet initialized (fixes crashes).
	(initialize_gtp_player): Bug-fix: only check if handicap is fixed
	if the number of stones doesn't exceed maximal fixed handicap for
	game's board size in the first place.  Otherwise an assertion in
	go_get_fixed_handicap_stones() fails.

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init):
	Center-justify `move_information_label'.
	(update_move_information): Print result when browsing the last
	node of main variation.
	(move_has_been_generated): Handle resignation of GTP engines.

2004-09-12  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-tree.c (sgf_node_get_result): New function.

	* sgf/sgf-utils.c (do_enter_tree): Keep value of new
	`last_main_variation_node' field of `SgfBoardState' structure
	valid.
	(descend_nodes): Likewise.
	(ascend_nodes): Likewise.

2004-09-10  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Add "Resign"
	menu item.
	(play_resign): New function.
	(update_children_for_new_node): Sensitize/desensitize "Resign"
	menu item.
	(go_scoring_mode_done): Add game result SGF property.
	(move_has_been_played): Likewise for Amazons and Othello.

	* sgf/sgf-utils.c (sgf_utils_append_variation): Rename from
	sgf_utils_append_move_variation().  Handle variations without
	moves (when `color' is set to `EMPTY').

	* sgf/sgf-tree.c (sgf_node_add_score_result) 
	(sgf_node_append_text_property): New functions.

	* gui-gtk/gtk-new-game-dialog.c (begin_game): Set game result to
	"Void" initially.

	* gtp/gtp-client.c (parse_generated_move): Handle "resign" answer
	of GTP engines.

	* board/board-topology.h (SPECIAL_X, SPECIAL_Y, SPECIAL_POSITION):
	New macros.
	* gtp/gtp-client.h (RESIGNATION_X, RESIGNATION_Y, RESIGNATION):
	New macros.

2004-09-09  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-utils.h
	(gtk_utils_make_window_only_horizontally_resizable): Define to
	nothing for pre-2.2 GTK+ (workaround GTK+ bug).

	* gui-gtk/gtk-parser-interface.c (gtk_parse_sgf_file): Don't use
	GTK_WIDGET() on NULL pointer.
	* gui-gtk/gtk-progress-dialog.c (gtk_progress_dialog_new):
	Likewise.

	* gui-gtk/gtk-assistant.c (gtk_assistant_update_buttons): Make
	`is_last_page' calculation work in pre-2.2 case.

	* gui-gtk/gtk-preferences.c (do_remove_gtp_engine): Pre-2.4 (or
	pre-2.2?) gtk_list_store_remove() didn't return anything.  Add
	special case.

	* gui-gtk/gtk-clock.c (gtk_clock_expose): Remove `const' from
	`black_color' and `gray_color' declaration to avoid warnings with
	earlier GTK+ versions.
	
2004-08-31  Paul Pogonyshev  <pogonyshev@gmx.net>

	* utils/utils.c (utils_parse_double): Bug-fix: don't skip one
	extra character when there is no decimal dot.

	* sgf/sgf-tree.c (sgf_node_get_time_limit): New function.

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Add "Game
	Information" menu item.  Initialize new `game_info_dialog' field.
	(gtk_goban_window_destroy): Destroy game info dialog if exists.
	(show_game_information_dialog, game_info_dialog_destroyed): New
	functions.
	(update_game_information): Call gtk_game_info_dialog_set_node() if
	game info dialog exists.

	* sgf/sgf-properties.list: Rename `SGF_RULES' to `SGF_RULE_SET'.

	* gui-gtk/gtk-game-info-dialog.c, gui-gtk/gtk-game-info-dialog.h:
	New files.

	* gui-gtk/gtk-utils.c (gtk_utils_create_entry): Add `mode'
	argument.
	(advance_focus): New function.
	(gtk_utils_align_left_widgets)
	(do_align_left_widgets, do_align_left_widget): New functions.
	(time_spin_button_output): Bug-fix: use sprintf() again,
	utils_ncprintf() doesn't know about field width.

2004-08-30  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-parser.c (sgf_parse_date): Fall back to
	sgf_parse_simple_text() for now.
	(sgf_parse_result): Implement with error checking.
	(looking_at, invalid_game_info_property): New functions.

2004-08-29  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-writer.c (sgf_write_file): Remove `1||' accidentally
	left in the code.

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_save): Use
	configuration variable to decide whether to force UTF-8.
	(save_file_as_response): Likewise.

	* gui-gtk/gtk-preferences.c: Add "Game Records (SGF)" category.
	(create_saving_sgf_page, store_toggle_setting): New functions.
	(update_board_background): Remove function.
	(update_board_markup): Remove GtkCheckButton case.
	(update_board_appearance): Add GtkToggleButton case.  Bug-fix:
	don't ignore first field of appearance structures.

	* gui-utils/common-configuration-sections.list: Add configuration
	parameter (whether to force UTF-8 encoding) for saving SGF files.
	* gui-utils/common-configuration-values.list: Likewise.
	* gui-utils/common-configuration-defaults.list: Likewise.

	* gui-gtk/gtk-new-game-dialog.c (begin_game): Use *cprintf()
	functions when locale-specific formatting is not needed and is not
	expected.
	* gui-gtk/gtk-tile-set.c (scale_and_paint_svg_image): Likewise.
	* gui-gtk/gtk-utils.c (time_spin_button_output): Likewise.
	* gui-utils/configuration.c (write_section): Likewise.
	* gui-utils/parse-configuration.c: Likewise.
	* gtp/gtp-client.c (send_command): Likewise.
	* sgf/parse-sgf-list.c: Likewise.
	* sgf/sgf-diff-utils.c (do_generate_text_diff): Likewise.
	* sgf/sgf-parser.c: Likewise.
	* sgf/sgf-tree.c (sgf_node_get_handicap): Likewise.
	* sgf/sgf-utils.c (sgf_utils_set_handicap): Likewise.
	* sgf/sgf-writer.c: Likewise.
	* board/board.c (game_format_point): Likewise.
	* board/parse-game-list.c (game_list_parse_game2): Likewise.
	* utils/parse-list.c (do_parse_lists): Likewise.

	* utils/buffered-writer.c (buffered_writer_vprintf): Properly
	handle cases when vsnprintf() returns -1.
	(buffered_writer_printf, buffered_writer_vprintf): New functions.

	* utils/string-buffer.c (string_buffer_vprintf): Properly handle
	cases when vsnprintf() returns -1.
	(string_buffer_cprintf, string_buffer_vcprintf): New functions.

	* utils/utils.c (FORMAT_DOUBLE_DECIMALS): Remove macro (replaced
	with new anonymous enumeration).
	(utils_cprintf, utils_vcprintf, utils_ncprintf, utils_vncprintf):
	New functions.
	(utils_vprintf): Properly handle vsnprintf() return value after
	the very first call.
	(utils_format_double): Remove function (code is inherited by
	utils_vncprintf()).
	(utils_parse_double): Allow the string contain '+' as the first
	character.

2004-08-28  Paul Pogonyshev  <pogonyshev@gmx.net>

	* (Quarry version 0.1.7.)

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): New
	sub-menus: "Edit" with "Preferences" item and "Help" with "About"
	item.
	(show_preferences_dialog, show_about_dialog)
	(about_dialog_destroy): New functions.

	* gui-gtk/gtk-preferences.c (gtk_preferences_dialog_present):
	Change type of `page_to_select' parameter to `gpointer'.

2004-08-27  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-tile-set.c (gtk_main_tile_set_create_or_reuse):
	Restore accidentally removed special case: only use odd-sized
	tiles for Go (otherwise they won't center properly).

	* gui-utils/tile-renderer.c (render_go_stones): Fix stone center
	positioning once more (previous fix didn't work in all cases).
	Remove debug output accidentally left in the code.
	(render_othello_disks): Likewise for disk center positioning.

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Make sure
	right side doesn't shrink below certain width (suggested by Arend
	Bayer).
	(force_minimal_width): New function.

2004-08-26  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-utils/tile-renderer.c (render_othello_disks): New function.
	* gui-gtk/gtk-tile-set.c (gtk_main_tile_set_create): Use
	render_othello_disks() for Othello.

2004-08-25  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban.c (set_goban_non_style_appearance): Update
	goban's SGF markup tile set.

	* gui-gtk/gtk-preferences.c (create_go_board_appearance_page):
	Create a page for markup appearance configuration.
	(create_amazons_board_appearance_page): Likewise.
	(create_othello_board_appearance_page): Likewise.
	(create_board_appearance_notebook_page): Add markup page to the
	notebook (passed as new parameter `markup_widget').
	(update_board_background): Remove only GtkColorButton case.
	Change `game_index's type to `gpointer'.
	(update_board_background_texture): Likewise for `game_index'.
	(create_markup_box, update_board_grid_and_labels_color)
	(use_theme_default_size, use_theme_default_opacity)
	(game_to_board_appearance_structure): New functions.
	(update_board_grid_and_labels_color, update_checkerboard_pattern):
	Remove functions.
	(update_board_appearance): New function, contains code from
	update_board_background(), update_board_grid_and_labels_color()
	and update_checkerboard_pattern().

	* gui-gtk/gtk-tile-set.c
	(gtk_sgf_markup_tile_set_create_or_reuse): Remove `theme'
	parameter.  Handle markup configuration.  Scale markup for Go when
	decrementing markup cell/pixbuf size.  Update for new
	`GtkSgfMarkupTileSetKey' format.
	(gtk_sgf_markup_tile_set_compare_keys): Update for new
	`GtkSgfMarkupTileSetKey' format.
	(gtk_sgf_markup_tile_set_duplicate_key): Likewise.
	(gtk_sgf_markup_tile_set_create): Handle markup configuration.
	Read files here instead of scale_and_paint_svg_image().  Reuse
	pixbufs when markup color over different backgrounds match.
	(scale_and_paint_svg_image): Empty `color_properties' string list
	just in case not all declared properties exist.

2004-08-24  Martin Holters  <martin.holters@gmx.de>

	* src/board/board.c (board_position_list_union): New function.

	* src/utils/string-list.c (string_list_count_items): New function.

	* src/gtp/gtp-client.c (gtp_client_final_status_list)
	(parse_final_status_list): New functions.
	* src/gui-gtk/gtk-goban-window.c (engine_has_scored)
	(enter_scoring_mode, cancel_scoring): New functions.
	(move_has_been_played): Invoke gtp_client_final_status_list() of
	GTP engine player(s) (if any) before user may score.

2004-08-23  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-utils.c (gtk_utils_create_selector): Pass items'
	text through _() also for pre-2.4 version of the function.
	(gtk_utils_create_selector_from_string_list): New function.

	* quarry.c (main): Invoke gui_utils_enumerate_themes() before
	anything else GUI-related and gui_utils_discard_theme_lists()
	afterwards.  Don't call gui_back_end_main_*() if
	gui_back_end_init() failed in the first place.

	* Makefile.am (AM_CPPFLAGS): Add `src/gui-utils' and `src/board'
	to include path (the latter is required by
	`src/gui-utils/gui-utils.h', not by `quarry.c' itself).

	* gui-utils/gui-utils.c (gui_utils_enumerate_themes)
	(gui_utils_discard_theme_lists): New functions.

	* gui-utils/configuration.c (configuration_read_from_file): Return
	non-zero if file is read successfully.

	* gui-utils/Makefile.am (AM_CPPFLAGS): Define `PACKAGE_DATA_DIR'.

	* utils/Makefile.am: Make `tags' target depend on `libutils.a' and
	`libparselist.a', as otherwise `make tags' won't work in a clean
	source tree.

2004-08-22  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-utils/markup-theme-configuration.list: New file.

	* gui-utils/common-configuration-values.list: Add configuration
	parameters for markup appearance for all supported games.
	* gui-utils/common-configuration-defaults.list: Likewise.

	* gui-gtk/gtk-goban-window.c (update_children_for_new_node): Move
	cursor to comment's first line.
	(fetch_comment_if_changed): Don't store empty comments, delete
	them.

	* sgf/sgf-utils.c (sgf_utils_normalize_text): Return NULL if
	normalized comment is empty.

2004-08-21  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_save): Make sure
	that the comment for the current node is saved if needed.
	(save_file_as_response): Likewise.
	(set_current_tree): Likewise.
	(update_children_for_new_node): Likewise, but for the node goban
	just left.  Append one newline to the displayed comment to ease
	editing.
	(fetch_comment_if_changed): New function.

	* sgf/sgf-utils.c (sgf_utils_normalize_text): New function.

	* sgf/sgf-tree.c (sgf_node_add_number_property): Add `overwrite'
	parameter.
	(sgf_node_add_real_property): Likewise.
	(sgf_node_add_pointer_property): Likewise.

	* sgf/sgf.h (sgf_node_add_double_property): Add `overwrite'
	parameter.
	(sgf_node_add_color_property): Likewise.
	(sgf_node_add_text_property): Likewise.
	(sgf_node_add_list_of_point_property): Likewise.
	(sgf_node_add_list_of_label_property): Likewise.

	* gettext.h (textdomain): Cast to `void' when NLS is disabled to
	avoid pointless compiler warnings.
	(bindtextdomain): Likewise.
	(bind_textdomain_codeset): Likewise.

	* gui-gtk/gtk-color-button.c: Use _().
	* gui-gtk/gtk-control-center.c: Likewise.
	* gui-gtk/gtk-gtp-client-interface.c: Likewise.

	* gui-gtk/gtk-games.c: Use N_().

	* gui-gtk/gtk-goban-window.c: Use _(), N_() and ngettext().  Tweak
	some strings to allow better l10n.

	* gui-gtk/gtk-new-game-dialog.c: Use _() and N_().
	* gui-gtk/gtk-parser-interface.c: Likewise.
	* gui-gtk/gtk-preferences.c: Likewise.
	* gui-gtk/quarry-stock.c: Likewise.

	* gui-gtk/gtk-utils.c (file_selection_response): Use _() and N_().
	(gtk_utils_create_selector): Invoke _() on items' text.
	(gtk_utils_create_radio_chain): Likewise for labels' text.

	* gettext.h: New file, copied from GNU gettext 0.14.1.
	* quarry.h (_, N_): New macros: i18n.
	* quarry.c (main): Initialize i18n text domain.

2004-08-19  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-new-game-dialog.c (begin_game): Set UTF-8 encoding
	for the created game tree.

	* sgf/sgf-writer.c (sgf_write_file): New parameter `force_utf8'.
	(write_game_tree): Write `CA' property.  Create an iconv handle
	for converting text property values if conversion is requested.
	(do_write_text): Tell buffered writer to convert text.  Skip UTF-8
	characters, not just bytes.
	(sgf_write_fake_simple_text): Likewise.
	(sgf_write_unknown): Likewise.

	* sgf/sgf-properties.list: Mark `CA' property as not stored.
	* sgf/sgf-parser.c (sgf_parse_char_set): New function.

	* utils/buffered-writer.c (buffered_writer_init): Reset new field
	`iconv_handle' to NULL.
	(buffered_writer_add_character): Convert incoming text using
	iconv(), if requested.
	(buffered_writer_add_newline): Likewise.
	(buffered_writer_cat_as_string): Likewise.
	(buffered_writer_vprintf): Likewise.
	(update_column): Count UTF-8 characters, not bytes.

	* utils/utils.h (buffered_writer_set_iconv_handle): New macro.

	* quarry.h (IS_UTF8_STARTER): New macro.

2004-08-18  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-parser.c: Start handling of non-UTF-8 encodings.
	(parse_buffer): Open/close iconv handles.
	(parse_root): Parse value of `CA' property and create an iconv
	handle for converting to UTF-8.
	(do_parse_simple_text): Invoke convert_text_to_utf8().
	(do_parse_text): Likewise.
	(convert_text_to_utf8): New function.

	* sgf/sgf-tree.c (sgf_game_tree_new): Initialize new `char_set'
	field.
	(sgf_game_tree_delete): Free `char_set'.
	(sgf_game_tree_duplicate): Duplicate value of `char_set'.

	* utils/utils.c (utils_duplicate_string): Allow `string' to be
	NULL.

2004-08-17  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban.c (gtk_goban_scroll_event): New
	function (navigate goban in respond to mouse wheel movement, wish
	#610, David Gmez).

2004-08-16  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-parser-interface.c (analyze_parsed_data): Free
	`data', don't leak memory.

2004-08-15  Paul Pogonyshev  <pogonyshev@gmx.net>

	* (Quarry version 0.1.6.)

	* gui-utils/tile-renderer.c (render_go_stones): Fix stone center
	positioning (used to be off by 0.5 pixels both horizontally and
	vertically).

2004-08-14  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban.c: Tweak stones' placement and size.
	(gtk_goban_size_allocate): Create a tile set for drawing SGF
	markup.
	(gtk_goban_expose): Draw SGF markup.
	(unreference_cached_objects): New function.
	(gtk_goban_update): Handle incoming SGF markup, don't ignore it.

	* gui-gtk/gui-back-end.c (gui_back_end_image_new)
	(gui_back_end_image_delete): Remove functions.

	* gui-gtk/gtk-tile-set.h: Rename from `gtk-tile-set-interface.h'.
	* gui-gtk/gtk-tile-set.c: New file (part of `gui-utils/tile-set.c'
	functionality and more).

	* gui-utils/tile-renderer.c (PIXEL): Remove macro.
	(tile_set_create_or_reuse, tile_set_unreference)
	(tile_set_dump_recycle): Remove functions.
	(render_go_stones): Rename from `create_go_stone_images'.  Only
	render basic images here (one black, one white).
	(duplicate_and_adjust_alpha, combine_pixels_diagonally): New
	functions.

	* gui-utils/tile-renderer.c: Rename from `tile-set.c'.
	* gui-utils/tile-renderer.h: Rename from `tile-set.h'.

	* utils/object-cache.c: New file (part of `gui-utils/tile-set.c'
	functionality).

2004-08-13  Paul Pogonyshev  <pogonyshev@gmx.net>

	* Makefile.am (quarry_LDADD): Remove recently added
	`QUARRY_RSVG_LIBS' (it is now merged into `QUARRY_GTHREAD_LIBS').
	* gui-gtk/Makefile.am (QUARRY_FULL_GTK_CFLAGS): Remove
	`QUARRY_RSVG_CFLAGS' (it is now merged into
	`QUARRY_GTHREAD_CFLAGS').
	(AM_CPPFLAGS): Remove `PACKAGE_TEXTURES_DIR', it is obviously
	derivable from `PACKAGE_DATA_DIR'.

2004-08-12  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-preferences.c (gtk_gtp_engine_dialog_present):
	Properly handle requests for modification of engine
	information (don't die with assertion failure).
	(gtk_gtp_engine_dialog_response, client_deleted): Handle "modify
	engine information" version of dialog.
	(update_engine_screen_name)
	(find_gtp_tree_model_iterator_by_engines_data): New
	functions (break out of chain_client_initialized()).

	* gui-gtk/quarry-stock.c: New stock item `QUARRY_STOCK_MODIFY'.

	* gui-gtk/gtk-preferences.c (create_background_table): Add button
	for browsing for a texture.
	(browse_for_gtp_engine, browsing_dialog_response): Remove
	functions.

	* gui-gtk/gtk-utils.c (gtk_utils_create_browse_button)
	(browse_button_clicked, browsing_dialog_response): New
	functions (mostly inherit code of removed functions in
	`gtk-preferences.c').

	* gui-gtk/gtk-preferences.c (gtk_preferences_dialog_present):
	Adapt page selection to new (tree) categories model.  Don't crash
	when invoked with preferences dialog already shown and
	`page_to_select' equal to -1.

2004-08-11  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-preferences.c: Split "Board Appearance" category
	into three (one per game).
	(gtk_preferences_dialog_present): Arrange preferences categories
	in a tree rather than in a list.
	(create_board_appearance_page): Remove function.
	(create_go_board_appearance_page)
	(create_amazons_board_appearance_page)
	(create_othello_board_appearance_page)
	(create_board_appearance_widgets)
	(create_board_appearance_notebook_page): New
	functions (essentially, inherit the code of removed
	create_board_appearance_page()).
	(gtk_preferences_dialog_change_page): Take care not to switch to
	nonexistent pages.

2004-08-10  Paul Pogonyshev  <pogonyshev@gmx.net>

	* board/go.c (go_mark_territory_on_grid): Detect false eyes that
	don't yield territory and don't mark them.

2004-08-09  Paul Pogonyshev  <pogonyshev@gmx.net>

	* Makefile.am (quarry_LDADD): Include `QUARRY_GTHREAD_LIBS' (split
	off from `QUARRY_GTK_LIBS') and new `QUARRY_RSVG_LIBS' flags.
	* gui-gtk/Makefile.am (QUARRY_FULL_GTK_CFLAGS): Include
	`QUARRY_GTHREAD_CFLAGS' (split off from `QUARRY_GTK_CFLAGS') and
	new `QUARRY_RSVG_CFLAGS'.

2004-08-07  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-preferences.c (create_gtp_engines_page): Create GTP
	engine information labels.
	(gtk_preferences_dialog_update_gtp_engine_info): Display selected
	GTP engine name, version, command line and supported games in
	corresponding labels.

	* gui-gtk/gtk-utils.c (gtk_utils_create_left_aligned_label): New
	function.

	* utils/string-list.c (string_list_implode): New function.

	* gui-gtk/gtk-goban.c (gtk_goban_expose): Draw a small rectangle
	to indicate focused state of widget.
	(gtk_goban_button_press_event): Grab focus when goban is clicked
	outside the playing area (e.g. on labels).
	(gtk_goban_focus_in_or_out_event): New function.

2004-08-04  Paul Pogonyshev  <pogonyshev@gmx.net>

	* quarry.c (main): Use `SIG_IGN' as signal handler for `SIGPIPE'.
	(catch_broken_pipe_signal): Remove function.

2004-07-22  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_save): Handle
	"Save" command, but issue warning about potential loss of
	information (bug #522, David Gmez).

2004-07-20  Paul Pogonyshev  <pogonyshev@gmx.net>

	* (Quarry version 0.1.5.)

	* gui-gtk/gtk-goban-window.c: Make it safe to navigate to a
	different node while a game (with GTP engines participating) is
	going on.
	(IS_DISPLAYING_GAME_NODE): New macro.
	(navigate_goban): Handle special cases of navigating from/to the
	current game node.
	(move_has_been_generated): Take care to attach new moves to the
	current game's node, not to the displayed node.

	* board/board.c (board_duplicate_without_stacks): New function.

2004-07-16  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-tree.c (sgf_game_tree_set_state): New function.

	* gui-utils/parse-configuration.c (configuration_parse_defaults2):
	Initialize a few variables to avoid compiler warnings.
	* gui-gtk/gtk-new-game-dialog.c (gtk_new_game_dialog_present):
	Likewise.
	(begin_game): Likewise.

2004-07-16  Martin Holters  <martin.holters@gmx.de>

	* board/go.c (go_score_game): Don't use utils_format_double(),
	format as user's locale specifies.
	* gui-gtk/gtk-goban-window.c (update_game_specific_information):
	Likewise.

	* sgf/sgf-tree.c (sgf_node_get_komi): Use utils_parse_double().
	* gui-utils/configuration.c (configuration_read_from_file):
	Likewise for parsing values of type `VALUE_TYPE_REAL'.

	* utils/utils.c (utils_format_double): Don't use sprintf() and
	thus be locale insensitive.
	(utils_parse_double): New function, parse doubles in
	locale-insensitive manner.

2004-06-19  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-utils.c (time_spin_button_input): Use new function
	utils_parse_time() (which contains the code previously resided
	here).

	* gui-gtk/gtk-utils.h (gtk_utils_set_selector_active_item_index):
	New macro.

	* gui-gtk/gtk-new-game-dialog.c (gtk_new_game_dialog_present):
	Initialize time control parameter widgets from configuration
	variables.
	(begin_game): Store time control configuration at successful game
	start.

	* gui-gtk/gtk-configuration-structures.c: Remove file.
	* gui-gtk/gtk-configuration-structures.h: Remove file.

	* gui-gtk/gtk-configuration.list: Ask `parse-configuration' to
	declare `NewGameConfiguration' structure.  Break game-specific
	variables out to separate sections.  Add time control variables
	for each game.

	* gui-utils/common-configuration-defaults.list: Update for new
	format of fields of structural types.

	* gui-utils/parse-configuration.c: Rewrite to allow random
	structure declarations and array fields.  Add support for
	configuration variables of `time' type.
	(push_subscription_stack, pop_subscription_stack)
	(recursively_build_full_field_name)
	(add_field_declaration_if_needed)
	(add_field_dispose_call_if_needed)
	(recursively_build_full_field_name): New functions.

	* gui-utils/configuration.c (configuration_read_from_file)
	(write_section): Add support for `time' configuration value type.
	(write_section): Change indentation of variable value from 16 to
	24 (variable names are usually long).

	* utils/parse-list.c (parse_thing): Allow `FIELD_NAME' to have '['
	as its first character.  Handle new thing type, `TIME_VALUE'.

	* utils/utils.c (utils_cat_string): Allow `string' argument to be
	NULL.
	(utils_cat_as_string): Likewise.
	(utils_format_double): Rename from format_double() and move here.
	(utils_parse_time): Break out from time_spin_button_input() (a
	function in `gui-gtk/gtk-utils.c').

	* utils/format.c: Remove file.

2004-06-18  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-parser.c (parse_property): Bug-fix: store return value
	of utils_cat_as_string() back in `(*link)->value.text'.

2004-06-12  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Create
	labels for displaying game-specific information (number of
	captures and komi for Go, number of disks for Othello).
	(set_current_tree): Hide the labels for Amazons (not used).
	(update_game_specific_information): New function, fill the labels
	with information.

	* gui-gtk/gtk-utils.c (gtk_utils_set_widgets_visible): New
	function.

	* board/othello.c (othello_count_disks): New function.

	* gui-utils/tile-set.c (create_go_stone_images): Create 50%
	transparent tile of mixed colors (half black, half white).
	* gui-gtk/gtk-goban-window.c (update_children_for_new_node): Mark
	positions with variations of both color with new tile.

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Create clock
	widgets for both players.
	(gtk_goban_window_enter_game_mode): Take care of time control.
	(initialize_gtp_player): Likewise.
	(move_has_been_played): Likewise.
	(generate_move_via_gtp, start_clock_if_needed): New functions.

	* gui-gtk/gtk-clock.c, gui-gtk/gtk-clock.h: New files.

	* gtp/gtp-client.c (COLOR_STRING): New macro.
	(gtp_client_send_time_settings, gtp_client_send_time_left): New
	functions.

2004-06-10  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-new-game-dialog.c (gtk_new_game_dialog_present): Add
	time control parameters widgets.
	(time_control_type_changed): New function.
	(begin_game): Create `TimeControl' objects when needed.

	* gui-gtk/gtk-utils.c (gtk_utils_create_time_spin_button)
	(time_spin_button_output, time_spin_button_input): New functions.

	* gui-gtk/gui-back-end.c (gui_back_end_timer_restart)
	(gui_back_end_timer_delete)
	(gui_back_end_timer_get_seconds_elapsed): New functions.

	* gui-utils/time-control.c, gui-utils/time-control.h: New files.

2004-06-06  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-utils.c (gtk_utils_create_selector)
	(gtk_utils_create_invisible_notebook): New functions.

2004-06-01  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-preferences.c (gtk_preferences_finalize): Remove.
	(gtk_preferences_init): Register `gtp_engines_list_store' with
	gui_back_end_register_object_to_finalize().

	* gui-gtk/gui-back-end.c
	(gui_back_end_register_object_to_finalize): New function.
	(run_main_loop): Dereference objects from `objects_to_finalize'
	list.

2004-05-27  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-preferences.c (chain_client_initialized): Update
	engine's information after successful initialization.  I.e. notice
	version upgrades, etc. automatically.

	* utils/string-list.c (string_list_duplicate_items): Bug-fix:
	don't leave the new list unterminated, write NULL in the last
	`next' pointer.

2004-05-21  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (initialize_gtp_player): Don't send
	`fixed_handicap 0' GTP command (specification requires to just
	omit it).

2004-05-13  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf.h: Remove types `SgfPoint', `SgfPositionList',
	`SgfAmazonsMoveData' and `SgfAbstractMoveData' and all `#define'd
	pseudo-functions.

	* sgf/sgf.h: Use types from board code instead of removed ones.	
	* sgf/sgf-diff-utils.c: Likewise.
	* sgf/sgf-parser.c: Likewise.
	* sgf/sgf-tree.c: Likewise.
	* sgf/sgf-utils.c: Likewise.
	* sgf/sgf-writer.c: Likewise.

	* (Quarry version 0.1.4.)

	* gui-gtk/gtk-goban-window.c (playing_mode_goban_clicked):
	Bug-fix: use `GOBAN_TILE_DONT_CHANGE' instead of `TILE_NONE'.
	Caused serious problems with all games when trying to play an
	illegal move.
	(free_handicap_mode_goban_clicked): Likewise.

2004-05-12  Paul Pogonyshev  <pogonyshev@gmx.net>

	* (Quarry version 0.1.3.)

	* gui-gtk/gtk-goban-window.c: Add support for user scoring of Go
	games.  Cope with the changes in goban's feedback handling.
	(update_territory_markup, go_scoring_mode_done)
	(reenter_current_node, go_scoring_mode_pointer_moved)
	(go_scoring_mode_goban_clicked): New functions.
	(play_pass_move): Call move_has_been_played() after updating
	controls for new SGF node so that the former function can change
	goban's contents.
	(playing_mode_goban_clicked): Likewise.
	(update_children_for_new_node): Make dead stones more transparent.
	(free_handicap_has_been_placed): Use reenter_current_node().

	* gui-gtk/gtk-goban.c: Add possibility for overlays to span
	several positions by using position lists.  Make overlays
	overwrite goban markup as well as the main grid.
	(gtk_goban_set_contents): Rename from
	gtk_goban_set_grid_contents().
	(set_feedback_data): Handle more feedback types, including goban
	markup overwriting feedbacks.

	* board/go.c (go_get_string_stones)
	(go_get_logically_dead_stones, go_score_game)
	(go_mark_territory_on_grid): New functions.

2004-05-10  Paul Pogonyshev  <pogonyshev@gmx.net>

	* board/board.c (board_position_list_sort)
	(board_position_lists_overlap)
	(board_position_list_find_position)
	(board_position_list_mark_on_grid): New functions.

	* utils/utils.c (utils_compare_ints): New function.

2004-05-09  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-new-game-dialog.c (set_handicap_adjustment_limits):
	Don't use adjustment properties: they only appeared in GTK+ 2.4.

2004-05-01  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-preferences.c (create_board_appearance_page): Add
	controls for configuring Amazons' checkerboard pattern.  Change
	controls layout: consider grid and labels a part of background.
	(update_board_grid_and_labels_color): Rename from
	update_board_foreground().
	(update_checkerboard_pattern): New function.

	* gui-utils/common-configuration-values.list: Rename "Foreground"
	configuration variable to "Grid and labels color".

	* gui-gtk/gtk-utils.c (gtk_utils_pack_in_box): Add a way to
	request packing in box end.
	(gtk_utils_create_mnemonic_label): New function.

	* gui-gtk/gtk-named-vbox.c (gtk_named_vbox_size_request)
	(gtk_named_vbox_size_allocate): Use `QUARRY_SPACING_SMALL' instead
	of the box spacing as distance between the label and the contents.
	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Use
	`QUARRY_SPACING_SMALL' instead of `QUARRY_SPACING_GOBAN_WINDOW'
	for the gap between players' control sets.

2004-04-30  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban.c (gtk_goban_expose): Don't draw clipped
	objects (significant speedup).
	(gtk_goban_expose): Draw checkerboard pattern if requested.
	(set_goban_style_appearance): Rename from
	set_goban_appearance_style().
	(set_goban_non_style_appearance): New function.  Only handles
	checkerboard pattern at present.

	* gui-utils/tile-set.c (tile_set_create_or_reuse): Initialize
	`cell_size' parameter of `TileSet' structure.

	* gui-utils/common-configuration-sections.list: Add configuration
	parameters for checkerboard pattern for Amazons board.
	* gui-utils/common-configuration-values.list: Likewise.
	* gui-utils/common-configuration-defaults.list: Likewise.

	* gui-utils/parse-configuration.c (configuration_parse_defaults2):
	Add support for structure fields in new (generated) structures.

	* gui-utils/common-configuration-values.list: Remove value
	identifiers (not used now).
	* gui-gtk/gtk-configuration.list: Likewise.

	* gui-utils/configuration.c (configuration_set_section_values):
	Remove function.
	(configuration_set_string_value)
	(configuration_set_string_list_value)
	(configuration_set_string_list_value_steal_strings): New
	functions.

	* utils/string-list.c (string_list_duplicate_items): Add `const'
	modifier to second argument.

	* gui-gtk/gtk-new-game-dialog.c (begin_game): Free `data'
	structure.

2004-04-29  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_finalize):
	Unreference `item_factory'.

2004-04-28  Paul Pogonyshev  <pogonyshev@gmx.net>

	* utils/utils.h (string_list_is_empty)
	(string_list_is_single_string): Don't cast to `const StringList *'
	to avoid GCC 3.3+ warnings.
	* gui-utils/configuration.c (write_section): Cast to `const
	StringList *' to cope with the above change.

	* gui-gtk/gtk-goban-window.c: Add full support for free handicap.
	(GTP_ENGINE_CAN_PLAY_MOVES): New macro.
	(gtk_goban_window_init): Create "special mode" control set.
	(gtk_goban_window_enter_game_mode): Enter free handicap special
	mode if user is to set up free handicap.
	(enter_special_mode, leave_special_mode)
	(free_handicap_mode_done)
	(set_goban_signal_handlers, free_handicap_mode_pointer_moved)
	(free_handicap_mode_goban_clicked)
	(free_handicap_has_been_placed): New functions.
	(navigate_goban): Rename from playing_mode_navigate_goban().
	Navigation should always work the same way or just be disabled.
	(initialize_gtp_player): Rewrite: make reentrant and more generic.
	(gtp_player_initialized_for_game): Remove (essentially include in
	the above function).
	(move_has_been_played): Rewrite.  Remove `color' parameter again.
	Generate moves even if opponent is not initialized.
	* gui-gtk/quarry-stock.c: New stock item `QUARRY_STOCK_DONE'.
	* gui-gtk/gtk-new-game-dialog.c (gtk_new_game_dialog_present):
	Don't desensitize free handicap controls: unneeded now.

	* gui-gtk/gtk-goban.h: New feedback types
	`GOBAN_FEEDBACK_ADD_BLACK_OR_REMOVE' and
	`GOBAN_FEEDBACK_ADD_WHITE_OR_REMOVE'.  Remove `_DEFAULT' from
	`GOBAN_FEEDBACK_MOVE' and its color variants.
	* gui-gtk/gtk-goban.c (gtk_goban_set_grid_contents)
	(gtk_goban_get_grid_contents, gtk_goban_diff_against_grid): New
	functions.
	(set_overlay_data): Allow setting overlay tile to `TILE_NONE'.
	(set_feedback_data): Handle new feedback types.  Cope with the
	above change.

	* gui-gtk/gtk-utils.h: Define gtk_entry_set_alignment() to nothing
	unless GTK+ version is 2.4 or higher.
	(G_MAXUINT8, G_MAXUINT16): Define if not yet defined by GLib
	headers.

	* gtp/gtp-client.c (gtp_client_place_free_handicap)
	(parse_free_handicap_placement, gtp_client_set_free_handicap): New
	functions.
	* board/board.c (game_format_position_list)
	(game_parse_position_list): New functions.

	* sgf/sgf-utils.c (sgf_utils_add_free_handicap_stones): New
	function.
	(determine_final_color_to_play): If there is positive handicap,
	set `sgf_color_to_play' to `WHITE' only if handicap stones are
	present in the same node.

2004-04-27  Paul Pogonyshev  <pogonyshev@gmx.net>

	* utils/memory-pool.c (memory_pool_free): Fix bug: do free the
	very last item in the pool if asked.  Fix typo: when profiling,
	increment the number of freed items, not of allocated ones.

	* sgf/sgf-diff-utils.c (generate_sgf_collection_diff)
	(generate_sgf_node_layer_diff): Initialize some variables to
	silence GCC warnings.
	* gui-utils/configuration.c (configuration_read_from_file):
	Likewise.
	* gui-gtk/gtk-utils.c (gtk_utils_create_titled_page): Likewise.

	* gui-gtk/gtk-color-button.c: Various backports to GTK+ pre-2.4
	and for compilation in Quarry source tree.  See file for details.

	* gui-gtk/quarry-marshal.list: New marshaller `VOID:VOID'.
	* gui-gtk/Makefile.am: Fix typo in `quarry-marshal.c' build rule:
	">", not ">>".

2004-04-26  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-color-button.c, gui-gtk/gtk-color-button.h: New
	files, copy from GTK+ version 2.4.0.  Rename to follow Quarry
	filename standard.  Modify to avoid compilation if GTK+ 2.4 is
	present anyway.

	* gui-gtk/gtk-preferences.c (create_board_appearance_page):
	Implement.  Add controls for all implemented board appearance
	configuration variables.
	(update_board_background, update_board_background_texture)
	(update_board_foreground): New functions.

	* gui-gtk/gtk-goban.c: Keep track of all goban widgets.
	(gtk_goban_update_appearance): New function.

	* utils/utils.h (QUARRY_COLORS_ARE_EQUAL): New macro.

	* gui-utils/common-configuration-defaults.list: Use value
	substitution for default texture file paths.
	* gui-gtk/Makefile.am: Pass `PACKAGE_TEXTURES_DIR' variable to
	`parse-configuration' utility.

	* gui-utils/parse-configuration.c (configuration_parse_defaults2):
	Read defaults of type `string' with parse_multiline_string() so
	that value substitution makes sense.

	* utils/parse-list.c: Add new `substitute_value' command support.
	Add command-line options support.
	(parse_list_main): Print help/usage messages to `stdout' or
	`stderr' according to GNU standards.
	(print_usage): New function.

	* utils/utils.h (AssociationList): New global string list type.
	* utils/string-list.c (association_list_item_dispose)
	(association_list_find_association): New functions.

	* utils/getopt.c, utils/getopt1.c, utils/getopt.h: New files, copy
	from GNU C Library version 2.3.2.

2004-04-25  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban.c: Use style modifiers instead of new style
	for changing widget appearance.
	(set_goban_appearance_style): New function.
	* gui-gtk/gtk-utils.c (gtk_utils_set_gdk_color)
	(gtk_utils_set_quarry_color): New functions.

	* gui-utils/parse-configuration.c (configuration_parse_sections2):
	Bug-fix: don't try to define new structure several times.

	* gui-utils/common-configuration-sections.list: Add configuration
	data for board appearance for Go, Amazons and Othello games.
	* gui-utils/common-configuration-values.list: Likewise.
	* gui-utils/common-configuration-defaults.list: Likewise.

	* gui-utils/configuration.c (configuration_read_from_file): Only
	consider first word of value when parsing values of non-string
	configuration variables.

	* gui-utils/parse-configuration.c: Add support for `color'
	configuration value type.
	* gui-utils/configuration.c: Likewise.

	* utils/utils.h (QuarryColor): New structure.
	* utils/parse-list.c (parse_color): New function.
	* gui-utils/configuration-internals.h: Include `utils.h' for the
	`QuarryColor' structure.

2004-04-24  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-utils/configuration.c (configuration_read_from_file): Close
	configuration file.

2004-04-23  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-configuration.list: Add configuration variables for
	game rules to "New Game Parameters" section.
	* gui-gtk/gtk-new-game-dialog.c (gtk_new_game_dialog_present): Use
	new configuration variables for initialization.
	(begin_game): Set them when beginning new game.

	* gui-utils/parse-configuration.c: Add support for configuration
	variables of type `real'.
	* gui-utils/configuration.c: Likewise.
	* gui-utils/configuration.c: Complete support for configuration
	variables of type `int' (reading from file).

	* gui-gtk/gtk-goban-window.c (initialize_gtp_player): Add support
	for fixed handicap and komi.
	* gtp/gtp-client.c (gtp_client_set_fixed_handicap)
	(gtp_client_set_komi): New functions.

	* sgf/sgf-tree.c (sgf_node_get_komi): New function.

	* gui-gtk/gtk-new-game-dialog.c: Implement game rules (partially).
	(show_game_specific_rules, set_handicap_adjustment_limits): New
	functions.
	
	* sgf/sgf-utils.c (sgf_utils_set_handicap): New function.
	* board/go.c (go_get_max_fixed_handicap)
	(go_get_fixed_handicap_stones): New functions.

	* gui-gtk/gtk-utils.c (gtk_utils_create_spin_button): New
	function.

2004-04-22  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-games.h (GTK_MIN_BOARD_SIZE, GTK_MAX_BOARD_SIZE):
	New macros.

	* quarry.h (MIN, MAX, ROUND_DOWN): New macros.  Use `#undef' to
	avoid conflicts with GLib or whatever else.

	* gui-gtk/gtk-utils.c (gtk_utils_create_titled_page): Don't use
	gtk_widget_show_all() on page contents (too intrusive).
	(gtk_utils_create_titled_page): Use gtk_utils_pack_in_box().
	* gui-gtk/gtk-assistant.c (gtk_assistant_add_page): Show added
	pages.

2004-04-21  Paul Pogonyshev  <pogonyshev@gmx.net>

	* (Quarry version 0.1.2.)

	* sgf/sgf-diff-utils.c: New file with various functions for
	comparing SGF game trees and their collections.
	* sgf/sgf-diff.c: New file with standalone `sgf-diff' utility
	code (very simplistic at present).

	* sgf/sgf-writer.c (sgf_write_file): Add empty line between SGF
	game trees.

	* sgf/sgf-tree.c (sgf_node_delete): Rewrite to reduce stack usage
	when branching factor is high (follow algorithm of
	parse_node_tree() and parse_node_sequence() from `sgf-parser.c').
	(sgf_node_count_subtree_nodes): Likewise (had different problem).
	(sgf_node_count_subtree_nodes): Rename from
	sgf_node_count_sub_tree_nodes().

	* sgf/sgf-tree.c (sgf_game_tree_duplicate)
	(sgf_game_tree_duplicate_with_nodes)
	(sgf_node_duplicate, sgf_node_duplicate_recursively)
	(sgf_node_duplicate_to_given_depth, sgf_property_duplicate): New
	functions.
	(sgf_label_list_duplicate): New function.

	* board/board.h (board_position_list_duplicate): New macro.
	* sgf/sgf.h (sgf_position_list_duplicate): New macro.

2004-04-20  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c (move_has_been_played): Fix crashes
	when `color_to_play' is EMPTY (happens in Othello games) by
	getting explicit `color' argument from the caller.

2004-04-18  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-parser.c (parse_buffer): Fix bug that prevented correct
	parsing of files with multiple SGF game trees.

2004-04-17  Paul Pogonyshev  <pogonyshev@gmx.net>

	* board/board.c (board_position_lists_are_equal): Rename from
	board_position_list_equal().
	* sgf/sgf.h (sgf_position_lists_are_equal): Likewise.

2004-04-16  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-goban-window.c
	(USER_CAN_PLAY_MOVES): New macro.
	(gtk_goban_window_init): New sub-menu "Play" with "Pass" item.
	(play_pass_move): New function.
	(update_children_for_new_node): Sensitize/desensitize "Pass" menu
	item depending on the current game and who is to play.

2004-04-15  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-gtk/gtk-utils.c (gtk_utils_create_message_dialog): Comment
	gtk_window_set_skip_taskbar_hint() call out because it prevents
	KDE window manager from giving message dialogs focus.  Also make
	dialog modal even it has no parent (unless flags tell otherwise).

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_save): Use
	gtk_utils_add_file_selection_response_handlers().
	* gui-gtk/gtk-parser-interface.c (gtk_parser_interface_present):
	Likewise.
	* gui-gtk/gtk-preferences.c (browse_for_gtp_engine): Likewise.

	* gui-gtk/gtk-utils.c
	(gtk_utils_add_file_selection_response_handlers)
	(overwrite_confirmation, file_selection_response): New functions.
	Ask user if she really wants to overwrite existing file.
	(gtk_utils_create_message_dialog): Remove `response_callback'
	argument.  Add `GTK_UTILS_DESTROY_ON_RESPONSE' flag to acomplish
	similar goal.
	* gui-gtk/quarry-stock.c: New stock item `QUARRY_STOCK_OVERWRITE'.

2004-04-14  Paul Pogonyshev  <pogonyshev@gmx.net>

	* gui-utils/tile-set.c (tile_set_dump_recycle): Bug-fix: don't
	deadlock when performing "lazy" recycling.

	* gui-gtk/gtk-utils.c (gtk_utils_set_menu_items_sensitive): New
	function.

	* gui-gtk/gtk-goban-window.c: Remove `navigate_goban' signal.
	(gtk_goban_window_init): Add "Go" (as verb) sub-menu.  Replace
	`navigate_goban' signal with generated `GtkAccelGroup' bindings.
	(update_children_for_new_node): Set items of "Go" sub-menu
	sensitive or insensitive depending on the node.

	* gui-gtk/gtk-goban.c (gtk_goban_class_init): Initialize
	`navigate' class member, even if GLib does that itself.
	* gui-gtk/gtk-preferences.c (engine_selector_destroyed): Free
	selector data, don't leak memory.

	* board/amazons.c (amazons_is_legal_move): Bug-fix: make function
	work properly when "to" point is a null point.

2004-04-13  Paul Pogonyshev  <pogonyshev@gmx.net>

	* sgf/sgf-writer.c (do_write_point_or_rectangle): Fix typo ('['
	instead of ']') that caused severe SGF file corruptions.

	* gui-gtk/gtk-goban-window.c: Add basic support for SGF file
	saving.  Note: quite dangerous now, because it never checks or
	asks anything, just writes.
	(gtk_goban_window_save)
	(save_file_as_response, save_file_as_destroy): New functions.

	* gui-gtk/gtk-goban-window.c (gtk_goban_window_init): Add menu bar
	to window (with just few items for now).

	* gui-gtk/Makefile.am: Remove custom build rules for
	`quarry-stock.o', because `QUARRY_WARNINGS_GTK' does not contain
	`-Wwrite-strings' (which is problematic for this file) anymore.


Changes before the project registration on Gna! (2004-04-12) were not logged.


  Copyright (C) 2004, 2005 Paul Pogonyshev.

  Copying and distribution of this file, with or without modification,
  are permitted provided the copyright notice and this notice are preserved.


Local Variables:
coding: iso-8859-1
End:
